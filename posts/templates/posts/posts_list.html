{% extends 'layout.html' %}
{% load tz %} <!-- para adicionar a timezone na data do post -->
{% load static %}
{% block title %}
    Posts
{% endblock %}

{%  block content%}
    <section>
        <h1>Posts</h1>

        {% for post in posts %}
            <article class="post">
                <h2>
                    <a href="{% url 'posts:page' slug=post.slug pk=post.pk %}">{{ post.title }}</a>
                </h2>

                {% if post.banner %}
                    <img src="{{ post.banner.url }}" alt="{{ post.title }}" class="post-img">
                {% else %}
                    <img src="{% static 'images/fallback.png' %}" alt="{{ post.title }}" class="post-img">
                {% endif %}

                <p>{{ post.body }}</p>
                <p>{{ post.date|timezone:"America/Sao_Paulo" }} by {{ post.author }}</p>

                {% if post.author == request.user %}

                <a href="{% url 'posts:update' pk=post.pk slug=post.slug %}">
                    <button class="form-submit">Update Post</button>
                </a>
                
                <div class="post-actions">
                    <button class="show-confirm" data-post="{{ post.pk }}">Delete Post</button>
                </div>

                <div class="confirm-delete" id="confirm-delete-{{ post.pk }}" style="display:none; margin-top:5px;">
                    <p>Are you sure you want to delete?</p>
                    <form action="{% url 'posts:delete' pk=post.pk slug=post.slug %}" method="post" style="display:inline;">
                        {% csrf_token %}
                        <button type="submit">Yes</button>
                    </form>
                    <button class="cancel-delete" data-post="{{ post.pk }}">No</button>
                </div>
                {% endif %}
            </article>
        {% endfor %}
    </section>

    <script>
        document.addEventListener('DOMContentLoaded', () => {
            document.querySelectorAll('.show-confirm').forEach(btn => {
                btn.addEventListener('click', () => {
                    const postId = btn.dataset.post;
                    btn.style.display = 'none';
                    document.getElementById(`confirm-delete-${postId}`).style.display = 'block';
                });
            });

            document.querySelectorAll('.cancel-delete').forEach(btn => {
                btn.addEventListener('click', () => {
                    const postId = btn.dataset.post;
                    document.getElementById(`confirm-delete-${postId}`).style.display = 'none';
                    document.querySelector(`.show-confirm[data-post="${postId}"]`).style.display = 'inline-block';
                });
            });
        });
    </script>

{% endblock %}